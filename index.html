import os
import asyncio
import logging
from contextlib import asynccontextmanager

from fastapi import FastAPI, Request
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel

from aiogram import Bot, Dispatcher, types
from aiogram.filters import CommandStart, CommandObject
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, WebAppInfo, Update
from aiogram.client.default import DefaultBotProperties
from aiogram.enums import ParseMode

import database as db

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
BOT_TOKEN = os.getenv("BOT_TOKEN", "YOUR_TOKEN_HERE")
WEBHOOK_URL = os.getenv("WEBHOOK_URL", "https://your-render-app.onrender.com/webhook")
WEB_APP_URL = os.getenv("WEB_APP_URL", "https://your-vercel-app-url.vercel.app")

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ –∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞
bot = Bot(token=BOT_TOKEN, default=DefaultBotProperties(parse_mode=ParseMode.HTML))
dp = Dispatcher()

# --- FastAPI Lifespan ---
@asynccontextmanager
async def lifespan(app: FastAPI):
    """
    –£–ø—Ä–∞–≤–ª—è–µ—Ç –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
    –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤–µ–±—Ö—É–∫ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∏ —É–¥–∞–ª—è–µ—Ç –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ.
    """
    logger.info("–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–µ–±—Ö—É–∫–∞ Telegram...")
    await bot.set_webhook(url=WEBHOOK_URL, allowed_updates=dp.resolve_used_update_types())
    yield
    logger.info("–£–¥–∞–ª–µ–Ω–∏–µ –≤–µ–±—Ö—É–∫–∞ Telegram...")
    await bot.delete_webhook(drop_pending_updates=True)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è FastAPI
app = FastAPI(lifespan=lifespan)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CORS (—Ä–∞–∑—Ä–µ—à–∞–µ–º –≤—Å–µ –¥–æ–º–µ–Ω—ã –¥–ª—è MVP)
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# --- FastAPI Endpoints ---

class CheckinRequest(BaseModel):
    tester_id: int
    app_id: int

@app.post("/api/checkin")
async def api_checkin(req: CheckinRequest):
    """
    –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è Web App. –û—Ç–º–µ—á–∞–µ—Ç –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
    –í—ã–∑–æ–≤ –ë–î –æ–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è –≤ asyncio.to_thread, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å event loop.
    """
    # –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É —á–µ–∫–∏–Ω–∞
    await asyncio.to_thread(db.update_daily_checkin, req.tester_id, req.app_id)
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∏ —Ç–µ—Å—Ç–µ—Ä–µ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    app_info = await asyncio.to_thread(db.get_app_info, req.app_id)
    tester_username = await asyncio.to_thread(db.get_tester_info, req.tester_id)
    
    if app_info:
        owner_id = app_info.get('owner_id')
        app_name = app_info.get('name')
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è —Ç–µ—Å—Ç–µ—Ä–∞ (—é–∑–µ—Ä–Ω–µ–π–º –∏–ª–∏ ID)
        username_str = f"@{tester_username}" if tester_username else f"ID: {req.tester_id}"
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü—É
        try:
            await bot.send_message(
                chat_id=owner_id,
                text=f"‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤—â–∏–∫ {username_str} —Ç–æ–ª—å–∫–æ —á—Ç–æ –∑–∞—à–µ–ª –≤ —Ç–≤–æ—ë –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ <b>{app_name}</b>!"
            )
        except Exception as e:
            # –ï—Å–ª–∏ –±–æ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∏–ª–∏ –¥—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞, –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º
            logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü—É {owner_id}: {e}")
            
    return {"status": "success"}

@app.get("/api/tasks/{user_id}")
async def api_get_tasks(user_id: int):
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –∏ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –Ω–æ–≤—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
    """
    to_test_today = await asyncio.to_thread(db.get_apps_to_test_today, user_id)
    available_apps = await asyncio.to_thread(db.get_available_apps, user_id)
    return {
        "to_test_today": to_test_today,
        "available_apps": available_apps
    }

@app.get("/api/projects/{owner_id}")
async def api_get_projects(owner_id: int):
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∏—Ö —Ç–µ—Å—Ç–µ—Ä–æ–≤.
    """
    projects = await asyncio.to_thread(db.get_my_apps_stats, owner_id)
    return projects

@app.post("/webhook")
async def telegram_webhook(request: Request):
    """
    –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–ø–¥–µ–π—Ç–æ–≤ –æ—Ç Telegram (Webhooks).
    """
    update_dict = await request.json()
    update = Update.model_validate(update_dict, context={"bot": bot})
    await dp.feed_update(bot, update)
    return {"status": "ok"}

# --- Aiogram Bot Logic ---

def get_webapp_keyboard() -> InlineKeyboardMarkup:
    """–°–æ–∑–¥–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–æ–π –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è Web App."""
    return InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(
                    text="üì± –û—Ç–∫—Ä—ã—Ç—å –î–∞—à–±–æ—Ä–¥",
                    web_app=WebAppInfo(url=WEB_APP_URL)
                )
            ]
        ]
    )

@dp.message(CommandStart())
async def cmd_start(message: types.Message, command: CommandObject):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start.
    –¢–∞–∫–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç Deep Links –≤–∏–¥–∞ t.me/BotName?start=app_5
    """
    user_id = message.from_user.id
    username = message.from_user.username or ""
    
    # –î–æ–±–∞–≤–ª—è–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º —é–∑–µ—Ä–∞ –≤ –ë–î (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —á–µ—Ä–µ–∑ to_thread)
    await asyncio.to_thread(db.add_user, user_id, username)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ (Deep Link)
    args = command.args
    if args and args.startswith("app_"):
        try:
            # –ò–∑–≤–ª–µ–∫–∞–µ–º ID –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏–∑ —Å—Ç—Ä–æ–∫–∏ "app_5"
            app_id = int(args.split("_")[1])
            
            # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Ç–µ—Å—Ç–µ—Ä–∞ –≤ –±–∞–∑–µ
            await asyncio.to_thread(db.start_testing, user_id, app_id)
            
            await message.answer(
                "‚úÖ <b>–í—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è!</b>\n\n"
                "–û—Ç–∫—Ä–æ–π—Ç–µ –¥–∞—à–±–æ—Ä–¥, —á—Ç–æ–±—ã —Å–∫–∞—á–∞—Ç—å –µ–≥–æ –∏ –æ—Ç–º–µ—Ç–∏—Ç—å—Å—è.",
                reply_markup=get_webapp_keyboard()
            )
            return
        except ValueError:
            # –ï—Å–ª–∏ –ø–æ—Å–ª–µ "app_" –∏–¥–µ—Ç –Ω–µ —á–∏—Å–ª–æ, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—ã—á–Ω—ã–π —Å—Ç–∞—Ä—Ç
            pass

    # –û–±—ã—á–Ω—ã–π –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞
    await message.answer(
        "üëã <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ DevTest Hub!</b>\n\n"
        "–ó–¥–µ—Å—å Android-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ–º–æ–≥–∞—é—Ç –¥—Ä—É–≥ –¥—Ä—É–≥—É –ø—Ä–æ—Ö–æ–¥–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ "
        "¬´20 —Ç–µ—Å—Ç–∏—Ä–æ–≤—â–∏–∫–æ–≤ –Ω–∞ 14 –¥–Ω–µ–π¬ª.\n\n"
        "–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —Å–≤–æ–π –¥–∞—à–±–æ—Ä–¥, –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ "
        "–∏–ª–∏ –Ω–∞—á–∞—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥—Ä—É–≥–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤.",
        reply_markup=get_webapp_keyboard()
    )
